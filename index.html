<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bons d‚Äôaccord ‚Äì Colis retour</title>
<style>
:root{--primary:#0057a8;--secondary:#f2f6fb;--danger:#c62828}
body{font-family:Arial;background:var(--secondary);padding:16px}
.card{background:#fff;padding:20px;border-radius:14px;margin-bottom:18px}
img.logo{max-width:260px;margin:0 auto 20px;display:block}
h2{color:var(--primary)}
select,input{width:100%;padding:14px;font-size:16px;border-radius:10px;border:1px solid #ccc;margin-bottom:12px}
button{width:100%;padding:14px;font-size:16px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-weight:bold;margin-top:6px}
button.secondary{background:#777}
button.danger{background:#c62828}
#preview img{width:80px;border-radius:8px;margin:4px}
progress{width:100%;height:20px;margin-top:10px}
.notice{background:#e8f5e9;color:#1b5e20;padding:10px;border-radius:10px;margin-top:10px;text-align:center;font-weight:bold}
.hidden{display:none}
</style>
</head>

<body>
<img src="logo.jpg" class="logo">

<div class="card">
<h2>üì∏ Ajout de photos</h2>

<select id="tournee">
<option value="">-- Tourn√©e --</option>
<option>B01</option><option>B02</option><option>B03</option><option>B04</option>
<option>B06</option><option>B07</option><option>B08</option>
<option>T09</option><option>T10</option><option>T11</option><option>T12</option>
<option>T13</option><option>T14</option><option>T15</option><option>T16</option>
<option>T17</option><option>T18</option><option>T19</option><option>T20</option>
<option>T21</option><option>T22</option><option>T23</option><option>T24</option>
<option>T26</option><option>T28</option><option>T29</option><option>T30</option>
<option>T31</option><option>T32</option><option>T33</option><option>T34</option><option>T37</option>
</select>

<input id="bon" placeholder="Num√©ro du bon d‚Äôaccord">

<input type="file" id="files" accept="image/*" multiple>

<div id="preview"></div>

<progress id="progress" value="0" max="100" class="hidden"></progress>
<div id="confirm" class="notice hidden">‚úÖ Photos envoy√©es avec succ√®s</div>

<button onclick="upload()">‚òÅÔ∏è Envoyer les photos</button>
<button class="secondary" onclick="resetForm()">Termin√©</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBD2yU8B8C-SL8gJMFEIa2PNzvBHuOjYmI",
 authDomain:"storage-retours.firebaseapp.com",
 projectId:"storage-retours"
};

const CLOUD_NAME="djwfusdud";
const UPLOAD_PRESET="bon accord";

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const files=document.getElementById("files");
const preview=document.getElementById("preview");
const progress=document.getElementById("progress");
const confirmBox=document.getElementById("confirm");
const tournee=document.getElementById("tournee");
const bon=document.getElementById("bon");

let photosTemp=[];

/* IMPORTANT: on ajoute, on ne r√©initialise pas */
files.addEventListener("change",()=>{
 [...files.files].forEach(file=>{
  const reader=new FileReader();
  reader.onload=e=>{
   photosTemp.push(e.target.result);
   const img=document.createElement("img");
   img.src=e.target.result;
   preview.appendChild(img);
  };
  reader.readAsDataURL(file);
 });
 files.value=""; // permet de rouvrir le s√©lecteur
});

async function uploadBase64(img,i,total){
 return new Promise(res=>{
  const xhr=new XMLHttpRequest();
  const form=new FormData();
  form.append("file",img);
  form.append("upload_preset",UPLOAD_PRESET);
  xhr.upload.onprogress=e=>{
   if(e.lengthComputable){
    progress.value=Math.round(((i+e.loaded/e.total)/total)*100);
   }
  };
  xhr.onload=async()=>{
   const d=JSON.parse(xhr.responseText);
   await addDoc(collection(db,"photos"),{
    tournee:tournee.value,
    bon:bon.value,
    date:new Date(),
    url:d.secure_url,
    traite:false
   });
   res();
  };
  xhr.open("POST",`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`);
  xhr.send(form);
 });
}

window.upload=async()=>{
 if(!photosTemp.length)return alert("Aucune photo");
 progress.classList.remove("hidden");
 confirmBox.classList.add("hidden");
 for(let i=0;i<photosTemp.length;i++){
  await uploadBase64(photosTemp[i],i,photosTemp.length);
 }
 progress.classList.add("hidden");
 confirmBox.classList.remove("hidden");
};

window.resetForm=()=>{
 photosTemp=[];
 preview.innerHTML="";
 bon.value="";
 tournee.value="";
 confirmBox.classList.add("hidden");
};
</script>

</body>
</html>
