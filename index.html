<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bons dâ€™accord â€“ Colis retour</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px}
img.logo{max-width:260px;margin:0 auto 16px;display:block}
img.thumb{max-width:80px;border-radius:6px}
.hidden{display:none}
progress{width:100%;height:40px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:10px;text-align:center}
button{margin:20px}
</style>
</head>
<body>

<img src="logo.jpg" class="logo">

<div class="card">
<h2>ğŸ“¸ Prise de photos</h2>
<select id="tournee">
<option value="">-- TournÃ©e --</option>
<option>B02</option><option>B03</option><option>B04</option><option>B06</option>
<option>T08</option><option>T09</option><option>T10</option><option>T11</option>
<option>T12</option><option>T13</option><option>T14</option><option>T15</option>
<option>T16</option><option>T17</option><option>T18</option><option>T19</option>
<option>T20</option><option>T21</option><option>T22</option><option>T23</option>
<option>T24</option><option>T26-32</option><option>T28</option><option>T29</option>
<option>T30</option><option>T31</option><option>T33</option><option>T34</option>
</select>
<input type="file" accept="image/*" capture="environment" multiple id="files">
<progress id="progress" value="0" max="100" class="hidden"></progress>
<button onclick="upload()">â˜ï¸ Envoyer les photos</button>
</div>

<div class="card">
<h2>ğŸ” Connexion admin</h2>
<input id="email" placeholder="Email admin">
<input id="password" type="password">
<button onclick="login()">Connexion</button>
</div>

<div id="admin" class="card hidden">
<h2>ğŸ“‹ Interface admin</h2>
<table>
<thead>
<tr><th>Photo</th><th>Date</th><th>TournÃ©e</th><th>Statut</th><th>Actions</th></tr>
</thead>
<tbody id="photos"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyBD2yU8B8C-SL8gJMFEIa2PNzvBHuOjYmI",
 authDomain: "storage-retours.firebaseapp.com",
 projectId: "storage-retours"
};

const CLOUD_NAME = "djwfusdud";
const UPLOAD_PRESET = "bon accord";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

async function uploadFile(file, index, total){
 return new Promise((resolve,reject)=>{
  const xhr = new XMLHttpRequest();
  const form = new FormData();
  form.append('file', file);
  form.append('upload_preset', UPLOAD_PRESET);

  xhr.upload.onprogress = (e)=>{
   if(e.lengthComputable){
    const percent = Math.round(((index + e.loaded/e.total) / total) * 100);
    document.getElementById('progress').value = percent;
   }
  };

  xhr.onload = async ()=>{
   const data = JSON.parse(xhr.responseText);
   await addDoc(collection(db,'photos'),{
    tournee: document.getElementById('tournee').value,
    date: new Date(),
    url: data.secure_url,
    traite: false
   });
   resolve();
  };

  xhr.onerror = reject;
  xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`);
  xhr.send(form);
 });
}

window.upload = async () => {
 const tournee = document.getElementById('tournee').value;
 const files = document.getElementById('files').files;
 if(!tournee) return alert("Choisir une tournÃ©e");
 if(!files.length) return alert("Aucune photo");

 const progress = document.getElementById('progress');
 progress.classList.remove('hidden');
 progress.value = 0;

 for(let i=0;i<files.length;i++){
  await uploadFile(files[i], i, files.length);
 }

 progress.value = 100;
 alert("Photos envoyÃ©es");
 document.getElementById('files').value = "";
 progress.classList.add('hidden');
}

window.login = () => {
 signInWithEmailAndPassword(auth,email.value,password.value)
 .then(()=>{document.getElementById('admin').classList.remove('hidden');loadPhotos();})
 .catch(e=>alert(e.message));
}

function loadPhotos(){
 onSnapshot(collection(db,'photos'),snap=>{
  photos.innerHTML='';
  snap.forEach(d=>{
   const p=d.data();
   photos.innerHTML+=`
    <tr>
     <td><a href="${p.url}" target="_blank"><img src="${p.url}" class="thumb"></a></td>
     <td>${new Date(p.date.seconds*1000).toLocaleString()}</td>
     <td>${p.tournee}</td>
     <td>${p.traite?'âœ…':'â³'}</td>
     <td>
      <button onclick="valider('${d.id}')">Valider</button>
      <button onclick="supprimer('${d.id}')">ğŸ—‘ï¸</button>
     </td>
    </tr>`;
  });
 });
}

window.valider=id=>updateDoc(doc(db,'photos',id),{traite:true});
window.supprimer=id=>deleteDoc(doc(db,'photos',id));
</script>

</body>
</html>
